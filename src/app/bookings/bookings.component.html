<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
/>

<div class="loader-container" *ngIf="loading">
  <div class="loader"></div>
</div>

<!-- Booking Invoice Modal -->
<!-- Booking Invoice Modal -->
<div class="modal" *ngIf="selectedBooking">
  <div class="modal-content">
    <span class="close" (click)="closeModal()">&times;</span>
    <div class="bill-container" id="invoiceContent">
      <div class="text-center">
        <h3>Booking Invoice</h3>
        <p>
          Booking ID: {{ selectedBooking.id }} |
          Type: {{ selectedBooking.mode }} |
          Time: {{ selectedBooking.time }}
        </p>

        <!-- Dropdown for status -->
       

        <hr />
      </div>

      <!-- Customer & Address -->
      <div class="row mb-3">
        <div class="col-md-6">
          <p><strong>Booked By</strong></p>
          <p><strong>Name:</strong> {{ selectedBooking.customer.name }}</p>
          <p><strong>Email:</strong> {{ selectedBooking.customer.email }}</p>
          <p><strong>Mobile:</strong> {{ selectedBooking.customer.mobile }}</p>
        </div>

        <div class="col-md-6">
          <p><strong>Deliver To</strong></p>
          <p><strong>Address:</strong> {{ selectedBooking.address.line }}</p>
          <p><strong>Landmark:</strong> {{ selectedBooking.address.landmark }}</p>
          <p><strong>City:</strong> {{ selectedBooking.address.city }}</p>
          <p><strong>Pincode:</strong> {{ selectedBooking.address.pincode }}</p>
        </div>
      </div>

      <!-- Products -->
      <p><strong>üõí Booked Products:</strong></p>
      <div class="table-responsive">
        <table class="table table-bordered text-center">
          <thead>
            <tr>
              <th>Image</th>
              <th>Product Name</th>
              <th>MRP</th>
                <th>Color</th> <!-- üî• Added -->
    <th>Size</th> 
              <th>
                {{ selectedBooking.mode === 'Retail' ? 'Retail Price' : 'Wholesale Price' }}
              </th>
              <th>Discount</th>
              <th>Qty</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let p of selectedBooking.products">
              <td><img [src]="p.image" alt="product" width="50"/></td>
              <td>{{ p.name }}</td>
               
              <td>{{ p.price | currency : 'INR' }}</td>
              <td>{{ p.color }}</td> <!-- üî• Added -->
    <td>{{ p.size }}</td>
              <td>
                {{
                  selectedBooking.mode === 'Retail'
                    ? (p.retailPrice | currency : 'INR')
                    : (p.wholesalePrice | currency : 'INR')
                }}
              </td>
              <td>{{ p.discount | currency : 'INR' }}</td>
              <td>{{ p.quantity }}</td>
              <td>{{ p.totalPrice | currency : 'INR' }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Payments -->
      <p class="mt-3"><strong>üí≥ Payment Details:</strong></p>
      <div class="table-responsive">
        <table class="table table-bordered text-center">
          <thead>
            <tr>
              <th>Transaction ID</th>
              <th>Amount</th>
              <th>Payment Time</th>
                <th>Payment Mode</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let pay of selectedBooking.payments">
              <td>{{ pay.transaction_id }}</td>
              <td>{{ pay.amount | currency : 'INR' }}</td>
              <td>{{ pay.payment_time }}</td>
            <td>{{ selectedBooking?.bookingMode }}</td>
            </tr>
          </tbody>
        </table>
      </div>
<!-- Payment Proof -->
<!-- Payment Proof -->
<!-- Payment Proof -->
<div class="payment-proof mt-3 text-center" *ngIf="selectedBooking?.paymentImage?.link">
  <p><strong>üì∑ Payment Proof:</strong></p>

  <!-- Small thumbnail -->
  <img [src]="selectedBooking.paymentImage.link"
       alt="Payment Proof"
       class="img-thumbnail mb-2"
       style="max-width: 120px; cursor: pointer;"
       (click)="viewImage(selectedBooking.paymentImage.link)" />

  <!-- Buttons -->
  <div class="d-flex justify-content-center gap-3">
    <!-- View Button -->
    <button class="btn btn-primary btn-sm" (click)="viewImage(selectedBooking.paymentImage.link)">
      üëÅ View
    </button>

    <!-- Download Button -->
    <a [href]="selectedBooking.paymentImage.link"
       [download]="selectedBooking.paymentImage.name"
       class="btn btn-success btn-sm">
      ‚¨á Download
    </a>
  </div>
</div>



<!-- Image Preview Modal -->
<!-- Full Image Preview Modal -->
<!-- Full Image Preview Modal -->
<div class="image-modal" *ngIf="showImageModal">
  <div class="image-modal-content">
    <span class="close-btn" (click)="closeImageModal()">&times;</span>
    <img [src]="previewImage" alt="Full Payment Proof" class="full-image" />
  </div>
</div>



      <!-- Booking History -->
      <!-- <p class="mt-3"><strong>üìú Status History:</strong></p>
      <div class="table-responsive">
        <table class="table table-bordered text-center">
          <thead>
            <tr>
              <th>Status</th>
              <th>Time</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let d of selectedBooking.bookingDetails">
              <td>{{ d.status }}</td>
              <td>{{ d.creation_time }}</td>
            </tr>
          </tbody>
        </table>
      </div> -->

      <!-- Totals -->
      <div class="text-end mt-3">
        <h5><strong>Total Price: {{ selectedBooking.totalAmount | currency:'INR' }}</strong></h5>
        <h6><strong>Paid: {{ selectedBooking.paidAmount | currency:'INR' }}</strong></h6>
        <!-- <h6><strong>Balance: {{ selectedBooking.balanceAmount | currency:'INR' }}</strong></h6> -->
        <h6><strong>Payment Mode: {{ selectedBooking.paymentType }}</strong></h6>
      </div>

   <table class="table table-bordered w-50 mx-auto text-center">
  <tr>
<th class="booking-status-header">Update Booking Status</th>
    <td>
      <select class="form-select status-select w-auto d-inline-block"
              [ngModel]="selectedBooking.status"
              (ngModelChange)="updateBookingStatus($event)">
        <option *ngFor="let s of bookingStatusEnum" [value]="s">
          {{ s }}
        </option>
      </select>
    </td>
  </tr>
</table>


    </div>
  </div>
</div>


<!-- Main content -->
<div class="hei">
  <section class="sec1 w-100">
    <div>
      <div class="container">
        <div class="header d-flex justify-content-between align-items-center">
          <h2 class="text-center my-4 w-100">All Bookings</h2>
          <div class="download-btn-wrapper"></div>
        </div>

        <div
          class="search-container row justify-content-center align-items-center"
        >
          <div class="form-group col-12 col-md-6 col-xl-3">
            <label>Search by Date</label>
            <input
              type="date"
              class="form-control"
              [(ngModel)]="filters.date"
              [max]="todayDate"
            />
          </div>

          <div class="form-group col-12 col-md-6 col-xl-3">
            <label>Type</label>
            <!-- trigger API when type changes -->
            <select class="form-select" [(ngModel)]="filters.type" (ngModelChange)="onTypeChange($event)">
              <option value="">All</option>
              <option value="Retail">Retail</option>
              <option value="Wholesale">Wholesale</option>
            </select>
          </div>

         <div class="form-group col-12 col-md-6 col-xl-3">
  <label>Booking Status</label>
 <select class="form-select" (ngModelChange)="onStatusChange($event)" [(ngModel)]="selectedStatus">
  <option value="">All</option>
    <option value="PENDING">Pending</option>
  <option value="CONFIRMED">Confirmed</option>
    <option value="PACKAGING">Packaging</option>
  <option value="ONTHEWAY">On the Way</option>
  <option value="COMPLETED">Completed</option>
  <option value="CANCELLED">Cancelled</option>
</select>

</div>


          <!-- <div class="form-group col-12 col-md-6 col-xl-3">
            <label>Enter Name</label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="filters.searchValue"
              [placeholder]="'Enter ' + getSearchPlaceholder()"
            />
          </div> -->

          <p class="booking-count mt-3 text-center">
            Number of bookings for search:
            <strong>{{ filteredBookings.length }}</strong>
          </p>
        </div>

        <div class="exam-table-container">
          <div class="exam-table-wrapper table-responsive">
            <table class="exam-table table table-bordered">
              <thead class="table-dark">
                <tr>
                  <th>Booking ID</th>
                  <th>Booking Date</th>
                  <th>Booking Status</th>
                  <th>Booked By</th>
                  <th>Type</th>
                  <th>Product Name</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let booking of filteredBookings">
                  <td class="text-center">{{ booking.id }}</td>
                  <td class="text-center">{{ booking.booking_date }}</td>
                  <td
                    class="text-center fw-bold"
                    [ngClass]="{
                      'text-success': booking.status === 'CONFIRMED' || booking.status === 'Completed',
                      'text-warning': booking.status === 'Processing',
                      'text-secondary': booking.status === 'PENDING' || booking.status === 'Pending',
                      'text-danger': booking.status === 'Cancelled'
                    }"
                  >
                    {{ booking.status }}
                  </td>

                  <td>{{ booking.bookedBy }}</td>
             <td>{{ booking.type }}</td>
                  <td>{{ booking.product_name}}</td>
                  <td class="text-center">
                    <!-- <button
                      class="btn btn-primary"
                      (click)="openModalWithId(booking.booking_id)"
                    >
                      View Details
                    </button> -->
                    <button class="btn btn-primary" [routerLink]="['/bookings', booking.booking_id]">
  View Details
</button>

                  </td>
                </tr>
                <tr *ngIf="filteredBookings.length === 0 && !loading">
                  <td colspan="7" class="text-center">No bookings found</td>
                </tr>
                <tr *ngIf="loading">
                  <td colspan="7" class="text-center">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>
